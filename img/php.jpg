<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Интернет-магазин</title>
	<link rel="stylesheet" href="style/normalize.css">

	</style>
	<link rel="stylesheet" href="style/style.css">
</head>

<body>

	<form method="post" enctype="multipart/form-data">
		<input type="hidden" name="MAX_FILE_SIZE" value="12097152">
		<input type="file" name="picture">
		<input type="submit" value="Загрузить файл!">
	</form>


	<?php

	require 'resize.php';

	// если была произведена отправка формы

	// $filePath  = $_FILES['picture'];

	if (isset($_FILES['picture'])) {
		// проверяем, можно ли загружать изображение
		$check = can_upload($_FILES['picture']);

		if ($check === true) {
			// загружаем изображение на сервер
			make_upload($_FILES['picture']);
			echo "<strong>Файл успешно загружен!</strong>";
		} else {
			// выводим сообщение об ошибке
			echo "<strong>$check</strong>";
		}
	}



	function can_upload($file) 	{

		$filePathTmp  = $_FILES['picture']['tmp_name'];
		$errorCode = $_FILES['picture']['error'];
		echo $filePathTmp;

			// 	$fi = finfo_open(FILEINFO_MIME_TYPE);
	// 	// Получим MIME-тип
	// 	$mimes = (string) finfo_file($fi, $filePathTmp);
	// 	// Закроем ресурс
	// 	finfo_close($fi);


		// если имя пустое, значит файл не выбран
		if ($file['name'] == '')
			return 'Вы не выбрали файл.';

		// Определяем настоящий MIME-тип картинки 
		// checkFileType($filePathTmp);

		//Определяем, был ли файл загружен без ошибок и при помощи HTTP POST
		checkErrorsAndPOST($errorCode, $filePathTmp);

		/* если размер файла 0, значит его не пропустили настройки 
		сервера из-за того, что он слишком большой */
		// if($file['size'] == 0)
		// 	return 'Файл слишком большой.';

		$image = getimagesize($filePathTmp); //Получаем размеры файла
		// print_r($image);
		$limitWidth  = 1920;
		$limitHeight = 1200;
		if ($image[1] > $limitHeight)          die('Высота изображения не должна превышать 768 точек.');
		if ($image[0] > $limitWidth)           die('Ширина изображения не должна превышать 1280 точек.');
	

		$mime = pathinfo($_FILES['picture']['name'])['extension']; //получаем расширение файла заказчика
		/* Вариант 2
		разбиваем имя файла по точке и получаем массив
		$getMime = explode('.', $file['name']);
		нас интересует последний элемент массива - расширение
		$mime = strtolower(end($getMime));
		*/

		$types = array('jpg', 'png', 'gif', 'jpeg');//массив допустимых расширений
		if (!in_array($mime, $types)) {
			return 'Недопустимый тип файла.';		// если расширение не входит в список допустимых
		}
			return true;
	}


	function checkFileType($filePathTmp) {
	


		$fi = finfo_open(FILEINFO_MIME_TYPE);
		// Получим MIME-тип
		$mimes = (string) finfo_file($fi, $filePathTmp);
		// Закроем ресурс
		finfo_close($fi);
		// Проверим ключевое слово image (image/jpeg, image/png и т. д.)
		if (strpos($mimes, 'image') === false) die('Можно загружать только изображения.');
	}

	function checkErrorsAndPOST($errorCode, $filePathTmp) {

		if ($errorCode !== UPLOAD_ERR_OK || !is_uploaded_file($filePathTmp)) { 

				// Массив с названиями ошибок
				$errorMessages = [
					UPLOAD_ERR_INI_SIZE   => 'Размер файла превысил значение upload_max_filesize в конфигурации PHP.',
					UPLOAD_ERR_FORM_SIZE  => 'Размер загружаемого файла превысил значение MAX_FILE_SIZE в HTML-форме.',
					UPLOAD_ERR_PARTIAL    => 'Загружаемый файл был получен только частично.',
					UPLOAD_ERR_NO_FILE    => 'Файл не был загружен.',
					UPLOAD_ERR_NO_TMP_DIR => 'Отсутствует временная папка.',
					UPLOAD_ERR_CANT_WRITE => 'Не удалось записать файл на диск.',
					UPLOAD_ERR_EXTENSION  => 'PHP-расширение остановило загрузку файла.',
				];

				$unknownMessage = 'При загрузке файла произошла неизвестная ошибка.'; // Если в массиве нет кода ошибки	
				$outputMessage = isset($errorMessages[$errorCode]) ? $errorMessages[$errorCode] : $unknownMessage;
				die($outputMessage); // Выводим название ошибки
			}
		}

	function make_upload($file)
	{
		// формируем уникальное имя картинки: случайное число и name
		$newName =  time() . "_" . $file['name'];
		$image = getimagesize($file['tmp_name']); //Получаем размеры файла
		print_r($image);
		$width  = $image[0] *.5;
		$height = $image[1] *.5;
		create_thumbnail($file['tmp_name'], 'img/small/' . $newName, $width, $height);
		move_uploaded_file($file['tmp_name'], 'img/big/' . $newName);
		// $image = getimagesize($file['tmp_name']);
		// print_r($image);

	}
	?>



</body>

</html>